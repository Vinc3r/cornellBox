<!doctype html>
<html>
<head>
    <title>Cornell box</title>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="css/styles.css" media="screen"/>
    <script src="js/babylon.3.1.js"></script>
    <script src="js/babylon.inspector.bundle.js"></script>
</head>

<body>
    <canvas id="canvas"></canvas>
    <script type="text/javascript">
        var canvas = document.getElementById("canvas");
        var engine = new BABYLON.Engine(canvas, true);
        var scene = new BABYLON.Scene(engine);
        var loader = BABYLON.SceneLoader.Append("assets/", "cornellBox-PBR.gltf", scene, function (scene) {
		
/* camera parameters */
        
        var universalCamera = new BABYLON.UniversalCamera("universalCamera", new BABYLON.Vector3(0,1,0), scene);
        universalCamera.speed = 0.1;
        universalCamera.fov = 1.2;
        universalCamera.minZ = 0.01;
        universalCamera.position = new BABYLON.Vector3(0, 1.5, 4);
        universalCamera.rotation = new BABYLON.Vector3(0, -3.15, 0);
        scene.activeCamera = universalCamera;
        scene.activeCamera.attachControl(canvas);
            
/* scene environment */
            
        scene.clearColor = new BABYLON.Color3.White;
        var helper = scene.createDefaultEnvironment({
            createGround: false,
            skyboxColor: new BABYLON.Color3.White,
            toneMappingEnabled: true,
            cameraContrast: 1,
            cameraExposure: 1
        });
            
/* lightmap assignation */
        
    var activateLightmap = true;
        
        if(activateLightmap){
            
            // set your object list here
            myLMobjects = [
                "cornellBox.000",
                "bloc.000",
                "suzanne.000"
            ];
            
            // set your lightmap channel below:
            // ambientTexture | lightmapTexture | lightmapTextureAsShadowMap
            lightmapChannel = "lightmapTextureAsShadowMap";
            console.log("lightmap channel: " + lightmapChannel);
            
            // set your lightmap file format
            texType = "png"
            
            for(i = 0; i < myLMobjects.length; i++){
                myLM = new BABYLON.Texture("assets/LM/" + myLMobjects[i] + ".LM." + texType, scene);
                myLM.name = myLMobjects[i] + ".LM";
                myLM.coordinatesIndex = 1;
                if(texType == "dds"){
                    myLM.vScale = 1;
                }
                else{
                    myLM.vScale = -1;
                }
                object = scene.getMeshByName(myLMobjects[i]);
                if(object.material.subMaterials == null){
                    lightmapAssignation(object.material, myLM);
                }
                else{
                    for(m = 0; m < object.material.subMaterials.length; m++){
                        lightmapAssignation(object.material.subMaterials[m], myLM);
                    }                
                }
            };
            
            function lightmapAssignation(mtl, myLM){
                if(lightmapChannel == "ambientTexture"){
                    mtl.ambientTexture = myLM;
                };
                
                if(lightmapChannel == "lightmapTexture"){
                    mtl.lightmapTexture = myLM;
                    mtl.useLightmapAsShadowmap = false;
                };
                
                if(lightmapChannel == "lightmapTextureAsShadowMap"){
                    mtl.lightmapTexture = myLM;
                    mtl.useLightmapAsShadowmap = true;
                };
            };
        };
        
/* reflection probes */
        
    activateReflProbes = true;
             
        if(activateReflProbes){        
            var sphereProbe = BABYLON.Mesh.CreateSphere("sphereProbe", 32, .25, scene);
            var sphereProbeMat = new BABYLON.PBRMaterial("sphereProbeMat", scene);
            sphereProbeMat.roughness = 0;
            sphereProbeMat.metallic = 1;
            sphereProbe.position = {x:0, y:1.5, z:0};
            sphereProbe.material = sphereProbeMat;
            
            var probe = new BABYLON.ReflectionProbe("reflectionProbe", 128, scene, true);
            probe.attachToMesh(sphereProbe);
            for(m = 0; m < myLMobjects.length; m++){
                probe.renderList.push( scene.getMeshByName(myLMobjects[m]) );
                console.log("probe push " + myLMobjects[m])
            }
            setTimeout(waitToPauseProbe, 2000);
            function waitToPauseProbe(){
                probe.refreshRate = BABYLON.RenderTargetTexture.REFRESHRATE_RENDER_ONCE;
                sphereProbeMat.reflectionTexture = probe.cubeTexture;
                console.log("probe paused")
            };
        };
            
/* material tweaks */
            
            mtlLight = scene.getMaterialByName("light.000");
            mtlLight.emissiveColor = new BABYLON.Color3.White;

            mtlCBdefault = scene.getMaterialByName("cornellBox.default.000");
            mtlCBdefault.albedoColor = new BABYLON.Color3.White;

            mtlCBground = scene.getMaterialByName("cornellBox.ground.000");
            mtlCBground.albedoColor = new BABYLON.Color3.White;
           
/* debug toolz */
            BABYLON.DebugLayer.InspectorURL = "js/babylon.inspector.bundle.js";
            //scene.debugLayer.show()
		
/* BJS engine */
        
            engine.runRenderLoop(function() {
                scene.render();
            });

            window.addEventListener("resize", function () {
                engine.resize();
            });
        });
    </script>
</body>
</html>