<!doctype html>
<html>

<head>
    <title>Cornell box - Standard workflow</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/styles.css" media="screen" />
    <script src="js/babylon.js"></script>
</head>

<body>
    <canvas id="canvas"></canvas>
    <script type="text/javascript">
        var canvas = document.getElementById("canvas");
        var engine = new BABYLON.Engine(canvas, true);
        var scene = new BABYLON.Scene(engine);
        scene.clearColor = BABYLON.Color3.White();
        scene.ambientColor = BABYLON.Color3.White();
        var uniformNumber = 1; //just to help in some Vector3 or Color3 operations

        // Add a camera to the scene and attach it to the canvas
        var universalCamera = new BABYLON.UniversalCamera("universalCamera", new BABYLON.Vector3(0, 1, 0), scene);
        universalCamera.speed = 0.1;
        universalCamera.fov = 1.2;
        universalCamera.minZ = 0.01;
        universalCamera.position = new BABYLON.Vector3(0, 1.5, -4);
        universalCamera.rotation = new BABYLON.Vector3(0, Math.PI * 2, 0);
        scene.activeCamera = universalCamera;
        scene.activeCamera.attachControl(canvas);

        function assignLightmap(material, lightmap) {
            material.diffuseColor = BABYLON.Color3.Black();
            // material.ambientColor = BABYLON.Color3.White();
            material.lightmapTexture = lightmap;
            // lightmap as shadow
            material.useLightmapAsShadowmap = true;
            //console.log("lightmap applied to " + material.name);
        }

        BABYLON.SceneLoader.ImportMesh(
            "",
            "assets/",
            "cornellBox-2.79-BlenderRender.babylon",
            scene,
            function (meshes) {
                //lightmaps handling
                var lightmappedObjects = [
                    "cornellBox.000",
                    "bloc.000",
                    "suzanne.000"
                ];
                for (let i = 0; i < lightmappedObjects.length; i++) {
                    // we create the lightmap using the mesh name
                    var lightmap = new BABYLON.Texture("assets/LM/" + lightmappedObjects[i] + ".LM.png", scene,
                        false, false);
                    lightmap.name = lightmappedObjects[i] + ".LM";
                    // using UV2
                    lightmap.coordinatesIndex = 1;
                    lightmap.vScale = -1;
                    var mesh = scene.getMeshByName(lightmappedObjects[i]);
                    if (!mesh || !mesh.material) {
                        //here, the mesh doesn't have material or mesh childs, we skip
                        continue;
                    }
                    if (mesh.material.subMaterials) {
                        // mesh have multiMaterials
                        for (let j = 0; j < mesh.material.subMaterials.length; j++) {
                            assignLightmap(mesh.material.subMaterials[j], lightmap);
                        }
                    }
                    if (mesh.material && !mesh.material.subMaterials) {
                        // mesh only have one material
                        assignLightmap(mesh.material, lightmap);
                    }
                }

                // some things on the logo mesh
                var bjsLogo = scene.getMeshByName("BJSlogo.000");
                bjsLogo.position.y = 1.5;
                scene.getMaterialByName("cornellBox_standard.BJS-3D-logo_white.01.000").emissiveColor = BABYLON.Color3
                    .White();
                var bjsRedMaterial;
                for (let k = 0; k < bjsLogo.material.subMaterials.length; k++) {
                    let currentMaterial = bjsLogo.material.subMaterials[k];
                    let currentMaterialDefaultColor = currentMaterial.ambientColor;
                    uniformNumber = 50;
                    currentMaterial.diffuseColor = new BABYLON.Color3(
                        currentMaterialDefaultColor.r - (currentMaterialDefaultColor.r * uniformNumber / 100),
                        currentMaterialDefaultColor.g - (currentMaterialDefaultColor.g * uniformNumber / 100),
                        currentMaterialDefaultColor.b - (currentMaterialDefaultColor.b * uniformNumber / 100)
                    );
                    if (currentMaterial.name.indexOf("logo_red") != -1) {
                        currentMaterial.specularColor = BABYLON.Color3.White();
                        currentMaterial.specularPower = 50;
                        bjsRedMaterial = currentMaterial;
                        continue;
                    }
                    currentMaterial.specularColor = BABYLON.Color3.White();
                    currentMaterial.specularPower = 20;
                }

                // prepare the room to receive shadows
                var cornellBox = scene.getMeshByName("cornellBox.000");
                cornellBox.receiveShadows = true;
                var cornellBoxGroundMtl = scene.getMaterialByName("cornellBox_standard.cornellBox.ground.000");
                cornellBoxGroundMtl.diffuseColor = BABYLON.Color3.White();
                cornellBoxGroundMtl.ambientColor = BABYLON.Color3.Black();

                // dyn light to generate shadows
                var light = new BABYLON.DirectionalLight("dirLight", new BABYLON.Vector3(0, -1, 0), scene);
                light.position = new BABYLON.Vector3(0, 3, 0);

                // logo shadow
                var shadowGenerator = new BABYLON.ShadowGenerator(128, light);
                shadowGenerator.setDarkness(0.75);
                shadowGenerator.useBlurExponentialShadowMap = true;
                shadowGenerator.addShadowCaster(bjsLogo);

                // why not using glow?
                var glowLayer = new BABYLON.GlowLayer("glow", scene, {
                    mainTextureFixedSize: 256,
                    blurKernelSize: 32
                })

                // some animations on the logo
                var frame = 0; //this will be used as a time variable
                scene.registerBeforeRender(function () {
                    frame += 0.1;
                    bjsLogo.rotation.x += .008;
                    bjsLogo.rotation.y -= .009;
                    bjsLogo.rotation.z -= .01;
                    bjsRedMaterial.emissiveColor = new BABYLON.Color3(
                        (Math.cos(frame) * 0.5) + 0.5,
                        0,
                        0
                    );
                    bjsLogo.position.y = (Math.cos(frame * 0.1) * 0.15) + 1.5;
                });

                //scene.debugLayer.show()
            }
        );

        engine.runRenderLoop(function () { // Register a render loop to repeatedly render the scene
            if (scene) {
                scene.render();
            }
        });

        window.addEventListener("resize", function () { // Watch for browser/canvas resize events
            engine.resize();
        });
    </script>
</body>

</html>