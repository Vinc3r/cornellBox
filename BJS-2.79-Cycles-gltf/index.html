<!doctype html>
<html>

<head>
    <title>Cornell box - PBR workflow</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/styles.css" media="screen" />
    <script src="js/babylon.js"></script>
</head>

<body>
    <canvas id="canvas"></canvas>
    <script type="text/javascript">
        var canvas = document.getElementById("canvas");
        var engine = new BABYLON.Engine(canvas, true);
        var scene = new BABYLON.Scene(engine);
        scene.clearColor = BABYLON.Color3.White();
        var hdrTexture = new BABYLON.CubeTexture.CreateFromPrefilteredData("assets/neutral_environment.env", scene);
        hdrTexture.name = "envTex";
        hdrTexture.gammaSpace = false;
        scene.environmentTexture = hdrTexture;

        // Add a camera to the scene and attach it to the canvas
        var universalCamera = new BABYLON.UniversalCamera("universalCamera", new BABYLON.Vector3(0, 1, 0), scene);
        universalCamera.speed = 0.1;
        universalCamera.fov = 1.2;
        universalCamera.minZ = 0.01;
        universalCamera.position = new BABYLON.Vector3(0, 1.5, 4);
        universalCamera.rotation = new BABYLON.Vector3(0, -3.15, 0);
        scene.activeCamera = universalCamera;
        scene.activeCamera.attachControl(canvas);

        var bjsLogo = null;

        //time to load the gltf file
        BABYLON.SceneLoader.ImportMesh(
            "",
            "assets/",
            "cornellBox-2.79-Cycles-gltf.gltf",
            scene,
            function () {
                //lightmaps handling
                var lightmappedObjects = [
                    "cornellBox.000",
                    "bloc.000",
                    "suzanne.000"
                ];
                for (i = 0; i < lightmappedObjects.length; i++) {
                    // we create the lightmap using the mesh name
                    //new Texture(url, scene, noMipmap, invertY, samplingMode, onLoad, onError, buffer, deleteBuffer, format)
                    var lightmap = new BABYLON.Texture("assets/LM/" + lightmappedObjects[i] + ".LM.png", scene,
                        false, false);
                    lightmap.name = lightmappedObjects[i] + ".LM";
                    // using UV2
                    lightmap.coordinatesIndex = 1;
                    var mesh = scene.getMeshByName(lightmappedObjects[i]);
                    var meshChildren = mesh.getChildren();
                    //gltf importer split multimat to children meshes
                    if (!mesh || !mesh.material && (meshChildren.length == 0)) {
                        //here, the mesh doesn't have material or mesh childs, we skip
                        continue;
                    }
                    // here the root mesh is divided into one submesh per material
                    if (!mesh.material && (meshChildren.length > 0)) {
                        // and cycle to its childrens, and so the abstract multimaterial list
                        for (j = 0; j < mesh._children.length; j++) {
                            var material = mesh._children[j].material;
                            // lightmap as shadow
                            material.lightmapTexture = lightmap;
                            material.useLightmapAsShadowmap = true;
                        }
                    }
                    if (mesh.material) {
                        // here we have one mesh with one submaterial
                        // lightmap as shadow
                        mesh.material.lightmapTexture = lightmap;
                        mesh.material.useLightmapAsShadowmap = true;
                    }
                }
            }
        );

        engine.runRenderLoop(function () {
            scene.render();
        });

        window.addEventListener("resize", function () { // Watch for browser/canvas resize events
            engine.resize();
        });
    </script>
</body>

</html>